---
import { getRelativeLocaleUrl } from 'astro:i18n';

import type { SupportedLocale, NavKey } from '@/types';
import { SITE_URL_MAP, I18N_DEFAULT_LOCALE, I18N_CONFIG } from '@/constants/config';

import HeaderLink from './HeaderLink.astro';

type SiteNav = {
  key: NavKey;
  path: string;
}

const locale = (Astro.currentLocale || I18N_DEFAULT_LOCALE) as SupportedLocale;
const i18n = I18N_CONFIG[locale];
const getLocaleUrl = getRelativeLocaleUrl.bind(null, locale);

const navs: SiteNav[] = [
  { key: 'posts', path: SITE_URL_MAP.posts },
  // { key: 'projects', path: SITE_URL_MAP.projects },
  { key: 'events', path: SITE_URL_MAP.events },
  { key: 'guides', path: SITE_URL_MAP.larkRepo },
  { key: 'about', path: SITE_URL_MAP.about },
];
---

<div class="relative">
  {/* 移动端汉堡菜单 */}
  <div class="sm:hidden">
    <button
      id="menu-button"
      class="flex items-center justify-center w-10 h-10 bg-white border border-gray-200 rounded-md focus:outline-none"
    >
      <svg id="menu-icon" class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>

    {/* 移动端下拉菜单 */}
    <div
      id="mobile-menu"
      class="absolute top-full right-0 bg-white border border-gray-200 rounded-md shadow-lg mt-1 py-2 z-50 hidden"
      style="min-width: 100px; width: auto;"
    >
      {navs.map(nav => (
        <a
          key={nav.key}
          href={nav.path.startsWith('http') ? nav.path : getLocaleUrl(nav.path)}
          class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
        >
          {i18n.navs[nav.key]}
        </a>
      ))}
    </div>
  </div>

  {/* 桌面端导航 */}
  <div class="hidden sm:flex space-x-6 internal-links">
    {navs.map(nav => (
      <HeaderLink href={nav.path.startsWith('http') ? nav.path : getLocaleUrl(nav.path)}>{i18n.navs[nav.key]}</HeaderLink>
    ))}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuButton = document.getElementById('menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuIcon = document.getElementById('menu-icon');

    if (menuButton && mobileMenu && menuIcon) {
      menuButton.addEventListener('click', function() {
        mobileMenu.classList.toggle('hidden');

        // 切换图标
        if (mobileMenu.classList.contains('hidden')) {
          menuIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>';
        } else {
          menuIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
        }
      });

      // 点击页面其他地方关闭菜单
      document.addEventListener('click', function(event) {
        if (!menuButton.contains(event.target) && !mobileMenu.contains(event.target)) {
          mobileMenu.classList.add('hidden');
          menuIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>';
        }
      });
    }
  });
</script>

<style>
  .internal-links a {
    padding: 0.5em 0;
    color: var(--black);
    border-bottom: 4px solid transparent;
    text-decoration: none;
    transition: border-bottom-color 0.2s ease;
  }

  .internal-links a:hover,
  .internal-links a.active {
    border-bottom-color: var(--accent);
  }
</style>
